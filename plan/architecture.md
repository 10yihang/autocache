# AutoCache 系统架构设计

## 1. 系统概述

AutoCache 是一个面向云原生环境设计的分布式缓存系统，采用 Golang 开发，兼容 Redis RESP 协议。

### 1.1 设计目标

| 目标 | 指标 |
|------|------|
| 高性能 | QPS > 100,000 |
| 低延迟 | P99 < 1ms |
| 高可用 | 99.99% |
| 弹性扩展 | 3 ~ 1000+ 节点 |
| 云原生 | K8s 原生调度与管理 |
| 成本优化 | 存储成本降低 30%+ |

### 1.2 核心特性

1. **Redis 协议兼容**：完整支持 RESP2 协议
2. **Gossip 集群**：去中心化的节点管理
3. **16384 Slots 分片**：一致性哈希分片
4. **冷热数据分层**：内存-SSD-云存储三级架构
5. **K8s Operator**：声明式集群管理
6. **调度增强**：拓扑感知 + 负载感知

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  redis-cli / redis-benchmark / Application (using Redis client SDK) │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ RESP Protocol
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Access Layer                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Load Balancer / K8s Service                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AutoCache Cluster                                  │
│                                                                              │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                 │
│  │   Node A    │◄────►│   Node B    │◄────►│   Node C    │                 │
│  │  (Master)   │      │  (Master)   │      │  (Master)   │                 │
│  │ Slot 0-5460 │      │Slot 5461-   │      │Slot 10923-  │                 │
│  │             │      │    10922    │      │    16383    │                 │
│  │ ┌─────────┐ │      │ ┌─────────┐ │      │ ┌─────────┐ │                 │
│  │ │Protocol │ │      │ │Protocol │ │      │ │Protocol │ │                 │
│  │ │ Server  │ │      │ │ Server  │ │      │ │ Server  │ │                 │
│  │ └────┬────┘ │      │ └────┬────┘ │      │ └────┬────┘ │                 │
│  │      │      │      │      │      │      │      │      │                 │
│  │ ┌────▼────┐ │      │ ┌────▼────┐ │      │ ┌────▼────┐ │                 │
│  │ │ Engine  │ │      │ │ Engine  │ │      │ │ Engine  │ │                 │
│  │ │  Hot    │ │      │ │  Hot    │ │      │ │  Hot    │ │                 │
│  │ │  Warm   │ │      │ │  Warm   │ │      │ │  Warm   │ │                 │
│  │ │  Cold   │ │      │ │  Cold   │ │      │ │  Cold   │ │                 │
│  │ └─────────┘ │      │ └─────────┘ │      │ └─────────┘ │                 │
│  │      │      │      │      │      │      │      │      │                 │
│  │ ┌────▼────┐ │      │ ┌────▼────┐ │      │ ┌────▼────┐ │                 │
│  │ │ Gossip  │◄├──────┼►│ Gossip  │◄├──────┼►│ Gossip  │ │                 │
│  │ │Cluster  │ │      │ │Cluster  │ │      │ │Cluster  │ │                 │
│  │ └─────────┘ │      │ └─────────┘ │      │ └─────────┘ │                 │
│  └─────────────┘      └─────────────┘      └─────────────┘                 │
│         │                    │                    │                         │
│         └────────────────────┴────────────────────┘                         │
│                              │                                               │
│                              ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Persistence Layer                                │   │
│  │   ┌───────────┐   ┌───────────┐   ┌───────────────────────────┐    │   │
│  │   │    RDB    │   │    AOF    │   │  SSD (BadgerDB) / S3      │    │   │
│  │   └───────────┘   └───────────┘   └───────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Kubernetes Layer                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       AutoCache Operator                             │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────────────┐  │   │
│  │  │   Reconciler  │ │   Scheduler   │ │  Monitoring (Prometheus) │  │   │
│  │  │               │ │   Plugins     │ │                           │  │   │
│  │  └───────────────┘ └───────────────┘ └───────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 分层架构

| 层级 | 组件 | 职责 |
|------|------|------|
| 接入层 | Protocol Server | RESP 协议解析、连接管理、命令分发 |
| 服务层 | Command Handler | 命令执行、路由判断、重定向处理 |
| 存储层 | Engine | KV 存储、过期管理、淘汰策略 |
| 分层层 | Tiered Manager | 冷热识别、数据迁移、透明访问 |
| 集群层 | Gossip | 节点发现、故障检测、元数据同步 |
| 持久层 | RDB/AOF | 数据持久化、崩溃恢复 |
| 管理层 | Operator | K8s 资源管理、弹性伸缩 |

---

## 3. 核心模块设计

### 3.1 存储引擎（Engine）

```
┌─────────────────────────────────────────────────────────────────┐
│                        Engine                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Entry Point                             │  │
│  │      Get() / Set() / Del() / Expire() / TTL()             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │   StringCmd   │  │   HashCmd     │  │   ListCmd     │ ...   │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
│              │               │               │                  │
│              └───────────────┼───────────────┘                  │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Sharded Dict                            │  │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐       ┌─────┐            │  │
│  │  │Sh 0 │ │Sh 1 │ │Sh 2 │ │Sh 3 │ ...   │Sh N │            │  │
│  │  │ RW  │ │ RW  │ │ RW  │ │ RW  │       │ RW  │            │  │
│  │  │Lock │ │Lock │ │Lock │ │Lock │       │Lock │            │  │
│  │  └─────┘ └─────┘ └─────┘ └─────┘       └─────┘            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │ Expiry Manager│  │   Evictor     │  │ Persistence   │       │
│  │ (Lazy+Active) │  │ (LRU/LFU)     │  │ (RDB/AOF)     │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

#### 设计要点

1. **分片锁**：256 个分片，降低锁竞争
2. **过期管理**：惰性删除 + 定期扫描
3. **淘汰策略**：支持 LRU/LFU/Random/TTL
4. **内存优化**：紧凑的数据结构

### 3.2 Gossip 集群

```
┌─────────────────────────────────────────────────────────────────┐
│                        Gossip Module                             │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Message Types                            │  │
│  │  PING / PONG / MEET / FAIL / PUBLISH / UPDATE             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │  Node Manager │  │ Slot Manager  │  │Failure Detect │       │
│  │               │  │               │  │               │       │
│  │ - Node Map    │  │ - 16384 Slots │  │ - PFAIL       │       │
│  │ - State       │  │ - Slot->Node  │  │ - FAIL        │       │
│  │ - Role        │  │ - Migration   │  │ - Quorum      │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Network Layer                           │  │
│  │  TCP Listener (ClusterPort) + Connection Pool              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

                    Message Flow
    ┌─────┐                              ┌─────┐
    │Node │──────── PING ───────────────►│Node │
    │  A  │         (with gossip         │  B  │
    │     │          about C,D)          │     │
    │     │◄──────── PONG ───────────────│     │
    │     │         (with gossip         │     │
    │     │          about E,F)          │     │
    └─────┘                              └─────┘
```

#### Gossip 协议流程

1. **PING/PONG**：每秒随机选择节点发送 PING
2. **Gossip 传播**：每个 PING/PONG 携带 3 个随机节点信息
3. **故障检测**：超时 15s 标记 PFAIL，半数以上报告则 FAIL
4. **配置传播**：Slot 变更通过 Gossip 传播

### 3.3 冷热分层

```
┌─────────────────────────────────────────────────────────────────┐
│                     Tiered Storage Manager                       │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Access Interface                         │  │
│  │          Get() / Set() / Del() - Transparent               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Stats Collector                          │  │
│  │  - Access Count (Count-Min Sketch)                         │  │
│  │  - Last Access Time                                        │  │
│  │  - Access Pattern Analysis                                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Tier Policy                              │  │
│  │  - Hot: AccessCount > 100 OR IdleTime < 5min              │  │
│  │  - Warm: AccessCount > 10 OR IdleTime < 30min             │  │
│  │  - Cold: IdleTime > 2h                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │   Hot Tier    │  │   Warm Tier   │  │   Cold Tier   │       │
│  │   (Memory)    │  │   (SSD)       │  │   (S3/OSS)    │       │
│  │               │  │               │  │               │       │
│  │   < 1ms       │  │   < 10ms      │  │   < 100ms     │       │
│  │   $$$         │  │   $$          │  │   $           │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
│              │               │               │                  │
│              └───────────────┼───────────────┘                  │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Migrator                                │  │
│  │  - Background Migration (Demote: Hot → Warm → Cold)       │  │
│  │  - On-access Promotion (Cold → Warm → Hot)                │  │
│  │  - Rate Limiting                                          │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 K8s Operator

```
┌─────────────────────────────────────────────────────────────────┐
│                       AutoCache Operator                         │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    CRD: AutoCache                          │  │
│  │                                                            │  │
│  │   apiVersion: cache.autocache.io/v1alpha1                 │  │
│  │   kind: AutoCache                                          │  │
│  │   spec:                                                    │  │
│  │     replicas: 3                                            │  │
│  │     tieredStorage:                                         │  │
│  │       enabled: true                                        │  │
│  │     scheduling:                                            │  │
│  │       topologyAware:                                       │  │
│  │         enabled: true                                      │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Reconciler                              │  │
│  │                                                            │  │
│  │   ┌─────────────────────────────────────────────────┐     │  │
│  │   │              Reconcile Loop                      │     │  │
│  │   │                                                  │     │  │
│  │   │  1. Get AutoCache CR                            │     │  │
│  │   │  2. Reconcile ConfigMap                         │     │  │
│  │   │  3. Reconcile Headless Service                  │     │  │
│  │   │  4. Reconcile Client Service                    │     │  │
│  │   │  5. Reconcile StatefulSet                       │     │  │
│  │   │  6. Update Status                               │     │  │
│  │   │  7. Initialize Cluster (if needed)              │     │  │
│  │   │                                                  │     │  │
│  │   └─────────────────────────────────────────────────┘     │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              ▼               ▼               ▼                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │  StatefulSet  │  │   Services    │  │  ConfigMap    │       │
│  │               │  │ - Headless    │  │               │       │
│  │  Pod-0        │  │ - Client      │  │ autocache.conf│       │
│  │  Pod-1        │  │               │  │               │       │
│  │  Pod-2        │  │               │  │               │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 数据流

### 4.1 读请求流程

```
Client                Node A              Node B (owns slot)
  │                     │                      │
  │──── GET key ───────►│                      │
  │                     │                      │
  │                     │ slot = CRC16(key) % 16384
  │                     │ owner = SlotManager.GetNode(slot)
  │                     │                      │
  │                     │── MOVED slot B ────►│
  │◄─── MOVED ─────────│                      │
  │                     │                      │
  │─────── GET key ─────────────────────────►│
  │                     │                      │ 1. Check Hot Tier
  │                     │                      │ 2. Check Warm Tier (if miss)
  │                     │                      │ 3. Check Cold Tier (if miss)
  │◄────── value ────────────────────────────│
  │                     │                      │
```

### 4.2 写请求流程

```
Client                Node (owns slot)        Persistence
  │                        │                      │
  │──── SET key val ──────►│                      │
  │                        │                      │
  │                        │ 1. Store in Hot Tier │
  │                        │ 2. Update Stats      │
  │                        │ 3. Write AOF ───────►│
  │                        │                      │
  │◄────── OK ─────────────│                      │
  │                        │                      │
```

### 4.3 冷热迁移流程

```
                  Migration Background Task
                           │
       ┌───────────────────┼───────────────────┐
       ▼                   │                   ▼
  Check Hot Tier           │            Check Warm Tier
       │                   │                   │
       ▼                   │                   ▼
  For each key:            │            For each key:
  - IdleTime > 5min?       │            - IdleTime > 2h?
  - AccessCount < 100?     │                   │
       │                   │                   ▼
       ▼                   │            Demote to Cold Tier
  Demote to Warm Tier      │            (Write to S3)
  (Write to SSD)           │                   │
       │                   │                   ▼
       ▼                   │            Delete from Warm
  Delete from Hot          │
       │                   │
       └───────────────────┴───────────────────┘
```

---

## 5. 部署架构

### 5.1 Kubernetes 部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes Cluster                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Namespace: autocache-system                        │   │
│  │                                                                      │   │
│  │   ┌─────────────────┐                                               │   │
│  │   │    Operator     │  Deployment (1 replica)                       │   │
│  │   │   Controller    │  - Watches AutoCache CRs                      │   │
│  │   └─────────────────┘  - Manages StatefulSets                       │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Namespace: default                                 │   │
│  │                                                                      │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │                 AutoCache CR: my-cache                       │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │              StatefulSet: my-cache                           │   │   │
│  │   │                                                              │   │   │
│  │   │   ┌───────────┐  ┌───────────┐  ┌───────────┐              │   │   │
│  │   │   │my-cache-0 │  │my-cache-1 │  │my-cache-2 │              │   │   │
│  │   │   │           │  │           │  │           │              │   │   │
│  │   │   │ Zone A    │  │ Zone B    │  │ Zone C    │   (Anti-     │   │   │
│  │   │   │           │  │           │  │           │   Affinity)  │   │   │
│  │   │   │ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │              │   │   │
│  │   │   │ │  PVC  │ │  │ │  PVC  │ │  │ │  PVC  │ │              │   │   │
│  │   │   │ │ 10Gi  │ │  │ │ 10Gi  │ │  │ │ 10Gi  │ │              │   │   │
│  │   │   │ └───────┘ │  │ └───────┘ │  │ └───────┘ │              │   │   │
│  │   │   └───────────┘  └───────────┘  └───────────┘              │   │   │
│  │   │                                                              │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  │                              │                                       │   │
│  │              ┌───────────────┼───────────────┐                      │   │
│  │              ▼               ▼               ▼                      │   │
│  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │   │
│  │   │  Headless Svc │  │  Client Svc   │  │   ConfigMap   │          │   │
│  │   │ my-cache-     │  │  my-cache     │  │ my-cache-     │          │   │
│  │   │ headless      │  │  :6379        │  │ config        │          │   │
│  │   └───────────────┘  └───────────────┘  └───────────────┘          │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Namespace: monitoring                              │   │
│  │                                                                      │   │
│  │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │   │
│  │   │  Prometheus   │  │   Grafana     │  │ AlertManager  │          │   │
│  │   │               │  │               │  │               │          │   │
│  │   │ Scrape:       │  │ Dashboard:    │  │ Notify:       │          │   │
│  │   │ /metrics      │  │ AutoCache     │  │ Slack/Email   │          │   │
│  │   └───────────────┘  └───────────────┘  └───────────────┘          │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 容错设计

### 6.1 节点故障

```
           Normal State                     After Node B Fails
    ┌───────────────────────┐         ┌───────────────────────┐
    │                       │         │                       │
    │   A ◄──────────► B    │         │   A ◄─── X ──── B     │
    │   │               │   │         │   │         (FAIL)    │
    │   │               │   │   ──►   │   │                   │
    │   └───────► C ◄───┘   │         │   └───────► C         │
    │                       │         │                       │
    │   Slots: 0-5460       │         │   Slots Reassigned    │
    │          5461-10922   │         │   to A and C          │
    │          10923-16383  │         │                       │
    └───────────────────────┘         └───────────────────────┘
    
    Timeline:
    T+0s:   B stops responding
    T+15s:  A and C mark B as PFAIL (local detection)
    T+15s:  A and C exchange PFAIL info via gossip
    T+15s:  Quorum reached, B marked as FAIL
    T+15s:  Broadcast FAIL message
    T+15s:  Slots reassigned (if replicas exist, failover)
```

### 6.2 网络分区

```
    Before Partition              During Partition
    ┌─────────────────┐         ┌─────────────────┐
    │  A ────── B     │         │  A ────── B     │
    │  │       │      │         │  │       │      │
    │  └── C ──┘      │         │  └── C ──┘      │
    │                 │   ──►   │                 │
    │  D ────── E     │         │  D ────── E     │
    │  │       │      │         │  │       │      │
    │  └── F ──┘      │         │  └── F ──┘      │
    │                 │         │       │         │
    │  Full Cluster   │         │  Partition!     │
    └─────────────────┘         └─────────────────┘
    
    Resolution:
    - Smaller partition (D,E,F) cannot reach quorum
    - Smaller partition rejects writes (cluster_state: fail)
    - After partition heals, nodes reconnect and sync
```

---

## 7. 性能优化

### 7.1 内存优化

| 优化项 | 方法 |
|--------|------|
| 分片锁 | 256 分片降低锁竞争 |
| 内存池 | sync.Pool 复用 buffer |
| 紧凑存储 | 小字符串内联存储 |
| 延迟释放 | 批量删除过期 key |

### 7.2 网络优化

| 优化项 | 方法 |
|--------|------|
| 连接池 | 复用集群间连接 |
| Pipeline | 批量处理请求 |
| 零拷贝 | 直接写入 socket |
| Gossip 优化 | 增量传播元数据 |

### 7.3 IO 优化

| 优化项 | 方法 |
|--------|------|
| 异步 AOF | 后台线程刷盘 |
| RDB 压缩 | LZ4 压缩快照 |
| 批量迁移 | Pipeline 迁移数据 |
| 分层存储 | 冷数据下沉 SSD |

---

本架构设计文档为 AutoCache 系统的总体设计参考，具体实现细节请参考各模块的详细设计文档。
